<!-- Message area: fixed height to prevent layout shifts -->
<div class="messages-container">
  <div *ngIf="loading" class="uk-alert-primary uk-margin-remove" uk-alert>
    Loading capabilities...
  </div>

  <div *ngIf="error" class="uk-alert-danger uk-margin-remove uk-border-rounded" uk-alert>
    {{ error }}
  </div>

  <div *ngIf="success" class="uk-alert-success uk-margin-remove uk-border-rounded" uk-alert>
    {{ success }}
  </div>
</div>

<h2 class="uk-heading-line uk-text-center capabilities-title uk-margin-remove-top" style=""><span>Node Endpoint</span></h2>

<div class="uk-margin uk-text-center" *ngIf="data && !loading">
  <input
    class="uk-input uk-border-rounded uk-width-1-2@m uk-width-1-1"
    type="text"
    [(ngModel)]="data.node_endpoint"
    [disabled]="!editingNodeEndpoint"
  />

  <!-- Toggle button -->
  <button
    class="uk-button uk-border-rounded uk-margin-small-left"
    [ngClass]="editingNodeEndpoint ? 'uk-button-primary' : 'uk-button-default edit-btn'"
    (click)="toggleNodeEndpointEdit()"
  >
    <span *ngIf="!editingNodeEndpoint" uk-icon="pencil"></span>
    <span *ngIf="editingNodeEndpoint">Save</span>
  </button>
</div>

<h2 class="uk-heading-line uk-text-center capabilities-title" style=""><span>Capabilities</span></h2>

<div class="uk-grid-small uk-child-width-1-2@s uk-grid-match" uk-grid *ngIf="data && !loading">
  <div *ngFor="let c of data.capabilities">
    <div class="uk-card uk-card-default uk-card-body uk-border-rounded">
      <h3 class="uk-card-title">
        {{ c.capability_type }}
        <span class="uk-icon-link uk-border-rounded uk-padding-small edit-icon" uk-icon="icon: pencil; ratio: 1"
              (click)="editCap(c)"></span>
      </h3>
      <p><strong>Endpoint:</strong>
        <ng-container *ngIf="isUrl(c.endpoint); else plainText">
          <a [href]="c.endpoint"
             target="_blank"
             rel="noopener noreferrer"
             class="uk-text-primary">
            {{ c.endpoint }}
          </a>
        </ng-container>
        <ng-template #plainText>
          {{ c.endpoint }}
        </ng-template>
      </p>
      <p><strong>Version:</strong> {{ c.version }}
        <span class="uk-icon-link uk-border-rounded uk-padding-small delete-icon" uk-icon="icon: trash; ratio: 1"
              (click)="confirmDelete(c)"></span>
      </p>
    </div>
  </div>
</div>

<hr class="uk-margin">

<h3>Add Capability</h3>
<form class="uk-form-stacked" (ngSubmit)="addCap()">
  <div class="uk-margin uk-width-1-2@m">
    <select class="uk-select uk-border-rounded" [(ngModel)]="newCapability.capability_type" name="type" required>
      <option value="" disabled selected>Select Capability Type</option>
      @for (type of capabilityTypes; track type) {
        <option [value]="type" [disabled]="isCapabilityTypeUsed(type)" [attr.uk-tooltip]="isCapabilityTypeUsed(type) ? 'Already added' : ''">
          {{ type }}
        </option>
      }
    </select>
  </div>
  <div class="uk-margin uk-width-1-2@m">
    <input class="uk-input uk-border-rounded" placeholder="Endpoint" [(ngModel)]="newCapability.endpoint" name="endpoint">
  </div>
  <div class="uk-margin uk-width-1-2@m">
    <input class="uk-input uk-border-rounded" placeholder="Version" [(ngModel)]="newCapability.version" name="version">
  </div>
  <button class="uk-button uk-button-primary uk-border-rounded" type="submit">Submit</button>
</form>

<!-- Delete Modal -->
<div id="delete-modal" uk-modal>
  <div class="uk-modal-dialog uk-modal-body uk-border-rounded">
    <h2 class="uk-modal-title">Delete Capability</h2>
    <p>Are you sure you want to delete this Capability?</p>
    <form (ngSubmit)="deleteCap()">
      <ng-container *ngIf="selectedCapability">
        <p class="uk-card-title">
          {{ selectedCapability.capability_type }}
        </p>
        <p><strong>Endpoint:</strong>
          <ng-container *ngIf="isUrl(selectedCapability.endpoint); else plainText">
            <a [href]="selectedCapability.endpoint"
               target="_blank"
               rel="noopener noreferrer"
               class="uk-text-primary">
              {{ selectedCapability.endpoint }}
            </a>
          </ng-container>
          <ng-template #plainText>
            {{ selectedCapability.endpoint }}
          </ng-template>
        </p>
        <p><strong>Version:</strong> {{ selectedCapability.version }}</p>
      </ng-container>
      <div class="uk-flex uk-flex-right uk-margin">
        <button type="button" class="uk-button uk-button-default uk-border-rounded uk-margin-right" (click)="closeDeleteModal()">Cancel</button>
        <button type="submit" class="uk-button uk-button-danger uk-border-rounded">Delete</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Modal -->
<div id="edit-modal" uk-modal>
  <div class="uk-modal-dialog uk-modal-body uk-border-rounded">
    <h2 class="uk-modal-title">Edit Capability</h2>
    <form (ngSubmit)="saveEdit()" *ngIf="selectedCapability">
      <div class="uk-margin">
        <label class="uk-form-label" for="editType">Capability Type</label>
        <select class="uk-select uk-border-rounded" [(ngModel)]="selectedCapability.capability_type" name="editType" required>
          <option value="" disabled selected>Select Capability Type</option>
          @for (type of capabilityTypes; track type) {
            <option [value]="type" [disabled]="isCapabilityTypeUsedInEdit(type)">
              {{ type }}
            </option>
          }
        </select>
      </div>
      <div class="uk-margin">
        <label class="uk-form-label" for="editEndpoint">Endpoint</label>
        <input id="editEndpoint" class="uk-input uk-border-rounded" [(ngModel)]="selectedCapability.endpoint" name="editEndpoint" placeholder="Endpoint">
      </div>
      <div class="uk-margin">
        <label class="uk-form-label" for="editVersion">Version</label>
        <input id="editVersion" class="uk-input uk-border-rounded" [(ngModel)]="selectedCapability.version" name="editVersion" placeholder="Version">
      </div>
      <div class="uk-flex uk-flex-right uk-margin">
        <button type="button" class="uk-button uk-button-default uk-border-rounded uk-margin-right" (click)="closeEditModal()">Cancel</button>
        <button type="submit" class="uk-button uk-button-primary uk-border-rounded">Save</button>
      </div>
    </form>
  </div>
</div>
